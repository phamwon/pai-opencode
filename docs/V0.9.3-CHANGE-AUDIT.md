# PAI-OpenCode v0.9.3 - Vollständiges Änderungs-Audit

**Erstellt:** 2026-01-20
**Scope:** Plural-Ordnernamen + chat.message Hook

---

## Übersicht

| Kategorie | Anzahl Änderungen | Risiko |
|-----------|-------------------|--------|
| Ordner-Umbenennungen | 3 | HOCH |
| TypeScript Tools | 4 Dateien / ~15 Stellen | MITTEL |
| Plugin-Dateien | 3 Dateien / ~8 Stellen | MITTEL |
| Skill-interne Dateien | ~35 Dateien / ~50+ Stellen | NIEDRIG |
| Dokumentation | ~25 Dateien / ~200+ Stellen | NIEDRIG |
| Neuer Hook | 1 Implementation | MITTEL |

---

## Phase 1: Ordner-Umbenennungen (ZUERST!)

**KRITISCH:** Diese müssen VOR allen Code-Änderungen durchgeführt werden!

```bash
cd ~/workspace/github.com/Steffen025/pai-opencode/.opencode

# 1. Agents umbenennen
mv agent agents

# 2. Plugins umbenennen
mv plugin plugins

# 3. Skills umbenennen
mv skill skills
```

**Abhängigkeit:** ALLE folgenden Änderungen setzen diese Umbenennungen voraus.

---

## Phase 2: Core Tools (Tools/*.ts)

### 2.1 pai-to-opencode-converter.ts

| Zeile | Alt | Neu | Kontext |
|-------|-----|-----|---------|
| 14 | `skills/ → skill/` | `skills/ → skills/` | Comment |
| 15 | `agents/ → agent/` | `agents/ → agents/` | Comment |
| 122-127 | WHAT GETS CONVERTED section | Update alle Pfade zu Plural | Help text |
| 323 | `join(target, "skill")` | `join(target, "skills")` | translateSkills() |
| 344 | `.opencode/skills/` | `.opencode/skills/` | Regex replacement |
| 478 | `join(target, "agent")` | `join(target, "agents")` | translateAgents() |
| 558-559 | `memorySource/Target` | Bleibt MEMORY (kein Change) | - |

**Zusätzlich Zeilen 586-623:** Hook → Plugin Migration Guide Beispiele prüfen

### 2.2 apply-profile.ts

| Zeile | Alt | Neu |
|-------|-----|-----|
| 13 | `const AGENTS_DIR = ".opencode/agent";` | `const AGENTS_DIR = ".opencode/agents";` |

### 2.3 skill-migrate.ts

| Zeile | Alt | Neu |
|-------|-----|-----|
| 11 | `--target .opencode/skills/SkillName` | ✅ Bereits Plural (KEIN CHANGE) |
| 48 | `.opencode/skills/CreateSkill` | ✅ Bereits Plural (KEIN CHANGE) |

---

## Phase 3: Plugin-Dateien (.opencode/plugins/)

### 3.1 pai-unified.ts → plugins/pai-unified.ts

Nach der Ordner-Umbenennung liegt die Datei in `.opencode/plugins/pai-unified.ts`.

**Interne Imports anpassen:**

| Zeile | Alt | Neu |
|-------|-----|-----|
| 17 | `./handlers/context-loader` | Bleibt (relative Pfade) |
| 18 | `./handlers/security-validator` | Bleibt (relative Pfade) |
| 19 | `./lib/file-logger` | Bleibt (relative Pfade) |

**NEUER HOOK hinzufügen (chat.message):**

```typescript
// Nach Zeile 187, vor "return hooks;":

/**
 * CHAT MESSAGE HANDLER (UserPromptSubmit equivalent)
 *
 * Called when user submits a message.
 * Use for: format enforcement, auto-work creation, rating capture.
 */
"chat.message": async (input, output) => {
  try {
    const content = (input as any).content || "";
    fileLog(`User message received: ${content.substring(0, 100)}...`, "debug");

    // Future: Format enforcement
    // Future: Auto-work creation
    // Future: Rating capture
  } catch (error) {
    fileLogError("Chat message handler failed", error);
  }
},
```

### 3.2 handlers/context-loader.ts → plugins/handlers/context-loader.ts

| Zeile | Alt | Neu |
|-------|-----|-----|
| 66 | `join(opencodeDir, "skill", "CORE")` | `join(opencodeDir, "skills", "CORE")` |

### 3.3 handlers/security-validator.ts → plugins/handlers/security-validator.ts

Prüfen auf hardcodierte Pfade (wahrscheinlich keine).

### 3.4 lib/identity.ts (falls vorhanden)

Suche nach hardcodierten Pfaden zu `skill/`, `agent/`, `plugin/`.

---

## Phase 4: Skill-interne Dateien (.opencode/skills/**)

### 4.1 CORE Skill

| Datei | Zeilen | Änderung |
|-------|--------|----------|
| `skills/CORE/SYSTEM/PAIAGENTSYSTEM.md` | 114, 186 | `.opencode/agents/` → `.opencode/agents/` |
| `skills/CORE/Tools/SkillSearch.ts` | 9-13, 152 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/GenerateSkillIndex.ts` | 8, 10 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/SessionHarvester.ts` | 22 | `../../../plugin/lib/` → `../../../plugins/lib/` |
| `skills/CORE/Tools/TranscriptParser.ts` | 20 | `../../../plugin/lib/` → `../../../plugins/lib/` |
| `skills/CORE/Tools/pai.ts` | 22 | `../../../plugin/lib/` → `../../../plugins/lib/` |
| `skills/CORE/Tools/SecretScan.ts` | 14 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/LoadSkillConfig.ts` | 10, 14, 253 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/SessionProgress.ts` | 9 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/GetTranscript.ts` | 7-8, 11-12 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/YouTubeApi.ts` | 6 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/RemoveBg.ts` | 14 | `~/.opencode/skills/` → `~/.opencode/skills/` |
| `skills/CORE/Tools/AddBg.ts` | 13 | `~/.opencode/skills/` → `~/.opencode/skills/` |

### 4.2 Agents Skill

| Datei | Zeilen | Änderung |
|-------|--------|----------|
| `skills/Agents/Tools/AgentFactory.ts` | 37-38 | `~/.opencode/skills/Agents/` → `~/.opencode/skills/Agents/` |

### 4.3 Art Skill

| Datei | Zeilen | Änderung |
|-------|--------|----------|
| `skills/Art/Lib/midjourney-client.ts` | 8 | `~/.opencode/skills/art/` → `~/.opencode/skills/art/` |
| `skills/Art/Lib/discord-bot.ts` | 8 | `~/.opencode/skills/art/` → `~/.opencode/skills/art/` |
| `skills/Art/Tools/ComposeThumbnail.ts` | 108, 126 | `~/.opencode/skills/Art/` → `~/.opencode/skills/Art/` |
| `skills/Art/Tools/Generate.ts` | 12 | `~/.opencode/skills/art/` → `~/.opencode/skills/art/` |
| `skills/Art/Tools/GeneratePrompt.ts` | 72 | `.opencode/skills/CORE/` → `.opencode/skills/CORE/` |
| `skills/Art/Tools/GenerateMidjourneyImage.ts` | 12 | `~/.opencode/skills/art/` → `~/.opencode/skills/art/` |

### 4.4 Telos Skill

| Datei | Zeilen | Änderung |
|-------|--------|----------|
| `skills/Telos/DashboardTemplate/Lib/telos-data.ts` | 12 | `.opencode/skills/CORE/USER/TELOS` → `.opencode/skills/CORE/USER/TELOS` |
| `skills/Telos/Tools/UpdateTelos.ts` | 39 | `../../../plugin/lib/` → `../../../plugins/lib/` |
| `skills/Telos/DashboardTemplate/App/api/upload/route.ts` | 6 | `.opencode/skills/life/telos` → `.opencode/skills/life/telos` |
| `skills/Telos/DashboardTemplate/App/api/file/save/route.ts` | 6 | `.opencode/skills/life/telos` → `.opencode/skills/life/telos` |

### 4.5 Recon Skill

| Datei | Zeilen | Änderung |
|-------|--------|----------|
| `skills/Recon/Tools/BountyPrograms.ts` | 49 | `~/.opencode/skills/Recon/Data` → `~/.opencode/skills/Recon/Data` |

---

## Phase 5: Dokumentation (*.md)

### 5.1 Root-Level Dokumente

| Datei | Änderungen |
|-------|------------|
| `CHANGELOG.md` | ~15 Stellen mit `.opencode/agents/`, `.opencode/skills/`, `.opencode/plugins/` |
| `ROADMAP.md` | ~10 Stellen |
| `constitution.md` | ~8 Stellen |
| `README.md` | ~5 Stellen |
| `RELEASE-v0.5.0.md` | ~4 Stellen |
| `AGENT-INVENTORY.md` | ~4 Stellen |

### 5.2 docs/ Verzeichnis

| Datei | Änderungen |
|-------|------------|
| `docs/TEST-PLAN-v0.9.md` | ~6 Stellen |
| `docs/AGENT-DELEGATION.md` | ~8 Stellen |
| `docs/CONVERTER.md` | ~3 Stellen |
| `docs/EVENT-MAPPING.md` | ~4 Stellen |
| `docs/PLUGIN-ARCHITECTURE.md` | ~3 Stellen |
| `docs/HANDOFF-v0.9-bugfix.md` | ~3 Stellen |

### 5.3 research/ Verzeichnis

| Datei | Änderungen |
|-------|------------|
| `research/SYNTHESIS.md` | ~6 Stellen |

### 5.4 .opencode/ interne Dokumente

| Datei | Änderungen |
|-------|------------|
| `.opencode/MIGRATION-REPORT.md` | ~11 Stellen (alle Agent-Dateien) |

---

## Phase 6: chat.message Hook Implementation

### 6.1 Recherche-Ergebnis

Aus ROADMAP.md und DeepWiki-Research:

```
UserPromptSubmit → chat.message (OpenCode native)
```

Der Hook ist **noch nicht in pai-unified.ts implementiert**.

### 6.2 Implementation in pai-unified.ts

```typescript
// Füge zu hooks hinzu:

"chat.message": async (input, output) => {
  try {
    const role = (input as any).message?.role || "unknown";
    const content = (input as any).message?.content || "";

    // Only process user messages
    if (role !== "user") return;

    fileLog(`[chat.message] User: ${content.substring(0, 100)}...`, "debug");

    // === FORMAT ENFORCEMENT ===
    // Check for required patterns (e.g., rating capture)

    // === AUTO-WORK CREATION ===
    // Auto-create work session if none active

    // === SKILL TRIGGER DETECTION ===
    // Check if message triggers a skill

  } catch (error) {
    fileLogError("chat.message handler failed", error);
  }
},
```

### 6.3 Use Cases für chat.message

1. **Format Enforcement** - Rating-Capture bei bestimmten Patterns
2. **Auto-Work Creation** - Automatische Work-Session bei Task-Start
3. **Skill Detection** - Proaktive Skill-Aktivierung basierend auf User-Input
4. **Context Injection** - Zusätzlicher Kontext basierend auf User-Input

---

## Ausführungs-Reihenfolge (KRITISCH!)

```
┌─────────────────────────────────────────────────────────────────┐
│ PHASE 1: Ordner umbenennen                                      │
│ ├── agent → agents                                              │
│ ├── plugin → plugins                                            │
│ └── skill → skills                                              │
├─────────────────────────────────────────────────────────────────┤
│ PHASE 2: Core Tools anpassen                                    │
│ ├── pai-to-opencode-converter.ts                                │
│ └── apply-profile.ts                                            │
├─────────────────────────────────────────────────────────────────┤
│ PHASE 3: Plugin-Dateien anpassen                                │
│ ├── pai-unified.ts (+ chat.message Hook!)                       │
│ └── handlers/context-loader.ts                                  │
├─────────────────────────────────────────────────────────────────┤
│ PHASE 4: Skill-interne Dateien (Search & Replace)               │
│ ├── Alle .ts mit plugin/lib → plugins/lib                       │
│ └── Alle .ts/.md mit skill/ → skills/                           │
├─────────────────────────────────────────────────────────────────┤
│ PHASE 5: Dokumentation (Search & Replace)                       │
│ ├── .opencode/agents/ → .opencode/agents/                        │
│ ├── .opencode/plugins/ → .opencode/plugins/                      │
│ └── .opencode/skills/ → .opencode/skills/                        │
├─────────────────────────────────────────────────────────────────┤
│ PHASE 6: Testen                                                 │
│ ├── opencode starten                                            │
│ ├── Context injection prüfen                                    │
│ ├── Security blocking testen                                    │
│ └── Agent delegation testen                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Bulk Search & Replace Commands

Nach Phase 1 (Ordner-Umbenennung):

```bash
cd ~/workspace/github.com/Steffen025/pai-opencode

# Skills
find . -name "*.ts" -o -name "*.md" | xargs sed -i '' 's|\.opencode/skills/|.opencode/skills/|g'
find . -name "*.ts" -o -name "*.md" | xargs sed -i '' 's|~/\.opencode/skills/|~/.opencode/skills/|g'

# Agents
find . -name "*.ts" -o -name "*.md" | xargs sed -i '' 's|\.opencode/agents/|.opencode/agents/|g'
find . -name "*.ts" -o -name "*.md" | xargs sed -i '' 's|~/\.opencode/agents/|~/.opencode/agents/|g'

# Plugins
find . -name "*.ts" -o -name "*.md" | xargs sed -i '' 's|\.opencode/plugins/|.opencode/plugins/|g'
find . -name "*.ts" -o -name "*.md" | xargs sed -i '' 's|~/\.opencode/plugins/|~/.opencode/plugins/|g'

# Relative imports (plugin/lib → plugins/lib)
find .opencode/skills -name "*.ts" | xargs sed -i '' 's|../../../plugin/lib/|../../../plugins/lib/|g'
```

---

## Risiko-Matrix

| Änderung | Risiko | Mitigation |
|----------|--------|------------|
| Ordner-Umbenennung | HOCH | Git commit VOR Umbenennung, Backup |
| Import-Pfade | MITTEL | TypeScript Compiler fängt Fehler |
| Dokumentation | NIEDRIG | Keine Laufzeit-Auswirkung |
| chat.message Hook | MITTEL | Feature Flag, schrittweise Aktivierung |

---

## Abhängigkeiten-Graph

```
Phase 1 (Ordner)
    ↓
Phase 2 (Tools) ←──────┐
    ↓                  │
Phase 3 (Plugins) ←────┤ Parallel möglich
    ↓                  │
Phase 4 (Skill-intern) ←┘
    ↓
Phase 5 (Docs) ← Kann parallel zu 4 laufen
    ↓
Phase 6 (Test) ← Muss nach allem kommen
```

---

## Checkliste für v0.9.3 Release

- [ ] Backup erstellt
- [ ] Phase 1: Ordner umbenannt
- [ ] Phase 2: Tools angepasst
- [ ] Phase 3: Plugins angepasst + chat.message Hook
- [ ] Phase 4: Skill-interne Dateien angepasst
- [ ] Phase 5: Dokumentation aktualisiert
- [ ] Phase 6: Tests bestanden
- [ ] CHANGELOG.md aktualisiert
- [ ] Git commit + tag v0.9.3
- [ ] README Badge aktualisiert

---

*Audit erstellt von THE ALGORITHM (DETERMINED effort)*
